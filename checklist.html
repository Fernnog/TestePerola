// Exibir Checklist de Produção em Nova Janela (HTML) - VERSÃO ATUALIZADA PARA TABELA
function exibirChecklistEmHTML(orcamento) {
    if (!orcamento) {
        console.error("exibirChecklistEmHTML: Orçamento inválido.");
        return;
    }
    console.log("Gerando checklist para orçamento:", orcamento.numero);
    console.log("Abrindo janela checklist...");
    const janelaChecklist = window.open('./checklist.html', '_blank');

    if (!janelaChecklist) {
        console.error("Falha ao abrir a janela de checklist. Provavelmente bloqueada pelo navegador.");
        alert("A janela do checklist foi bloqueada pelo navegador. Por favor, permita pop-ups para este site e tente visualizar o checklist na lista de orçamentos.");
        return;
    }
    console.log("Janela checklist aberta:", janelaChecklist);

    janelaChecklist.onload = () => {
        console.log("checklist.html carregado, buscando #conteudo-checklist");
        const conteudoChecklistDiv = janelaChecklist.document.getElementById("conteudo-checklist");

        if (!conteudoChecklistDiv) {
            console.error("Elemento #conteudo-checklist não encontrado em checklist.html");
            janelaChecklist.close();
            return;
        }

        // ***** INÍCIO DA GERAÇÃO DO HTML COM TABELA *****
        let checklistHtml = `
            <div class="info-cliente-tema">
                <strong>Orçamento Nº:</strong> <span>${orcamento.numero || 'N/A'}</span><br>
                <strong>Cliente:</strong> <span>${orcamento.cliente || 'Não informado'}</span><br>
                ${orcamento.tema ? `<strong>Tema:</strong> <span>${orcamento.tema}</span><br>` : ''}
                ${orcamento.cores ? `<strong>Cores:</strong> <span>${orcamento.cores}</span>` : ''}
            </div>
            <div class="checklist-container">
                <h3>Itens a Produzir/Separar</h3>
                <table class="checklist-table">
                    <thead>
                        <tr>
                            <th class="col-check">Feito</th>
                            <th class="col-qtd">Qtd.</th>
                            <th class="col-desc">Descrição</th>
                        </tr>
                    </thead>
                    <tbody>`; // Abre o tbody

        if (orcamento.produtos && orcamento.produtos.length > 0) {
            orcamento.produtos.forEach((produto, index) => {
                // Gera um ID único para o checkbox e label
                const cleanDescricao = (produto.descricao || `item-${index}`).replace(/[^a-zA-Z0-9-_]/g, '');
                const checkboxId = `chk-${cleanDescricao}-${index}`; // Usa index para garantir unicidade

                checklistHtml += `
                    <tr>
                        <td class="col-check">
                            <input type="checkbox" id="${checkboxId}">
                        </td>
                        <td class="col-qtd">
                            ${produto.quantidade || 0}x
                        </td>
                        <td class="col-desc">
                            <label for="${checkboxId}">${produto.descricao || 'Sem descrição'}</label>
                        </td>
                    </tr>`;
            });
        } else {
            checklistHtml += `<tr><td colspan="3" style="text-align: center; padding: 20px;">Nenhum produto listado neste orçamento.</td></tr>`;
        }

        checklistHtml += `
                    </tbody>
                </table>
            </div>`; // Fim checklist-container e table
        // ***** FIM DA GERAÇÃO DO HTML COM TABELA *****

        conteudoChecklistDiv.innerHTML = checklistHtml;
        console.log("Conteúdo do checklist (tabela) inserido em checklist.html.");
    };

    janelaChecklist.onerror = (err) => {
        console.error("Erro ao carregar checklist.html:", err);
        alert("Ocorreu um erro ao tentar abrir a visualização do checklist.");
    };
}
